{% extends 'search/base.html' %}
{% block content %}

{% load custom_tags %}

<div id="content" class="d-grid gap-4">

<div class="btn-group btn-group-sm">
    {% for d in days %}
    {% if forloop.first %}
    <a class="btn btn-secondary {% if td == d.td %}active{% endif %}"
       style="border-top-left-radius: 9999px; border-bottom-left-radius: 9999px;" href="javascript: change_day({{ d.td }});">{{ d.wd }}<br>{{ d.day }}</a>
    {% elif forloop.last %}
    <a class="btn btn-secondary {% if td == d.td %}active{% endif %}"
       style="border-top-right-radius: 9999px; border-bottom-right-radius: 9999px;" href="javascript: change_day({{ d.td }});">{{ d.wd }}<br>{{ d.day }}</a>
    {% else %}
    <a class="btn btn-secondary {% if td == d.td %}active{% endif %}" href="javascript: change_day({{ d.td }});">{{ d.wd }}<br>{{ d.day }}</a>
    {% endif %}
    {% endfor %}
</div>

{% for key, val in stops.items %}
<div id="{{ key }}" class="list-group" style="border-radius: 29.6px">
    <div class="list-group-item list-group-item-dark">
            <div class="row">
                <div class="col">
                    <a class="text-dark text-opacity-75 text-decoration-none" href="/station/?id={{ key }}">
                    {% if station.provider == 'zet' %}
                        {{ val.hs }}
                    {% elif station.provider == 'hzpp' %}
                        {{ station.stop_name }}
                    {% endif %}
                    </a>
                </div>
                {% comment %} <div class="col-auto">
                    <a href="/station/?id={{ key }}" style="color: black;"><i
                            class="bi bi-box-arrow-up-right"></i></a>
                </div> {% endcomment %}
                <div class="col-auto">
                    <a href="?id={{ key }}" style="color: black;"><i class="bi bi-pin-map"></i></a>
                </div>
                <div class="col-auto">
                    <a onclick="save_stop('{{ key }}')" style="color: black;">
                        {% if key in request.COOKIES.saved_stops %}
                        <i id="save-fill-{{ key }}" class="bi bi-star-fill"></i>
                        <i id="save-nfill-{{ key }}" class="bi bi-star" style="display:none;"></i>
                        {% else %}
                        <i id="save-fill-{{ key }}" class="bi bi-star-fill" style="display:none;"></i>
                        <i id="save-nfill-{{ key }}" class="bi bi-star"></i>
                        {% endif %}
                    </a>
                </div>
            </div>
    </div>

    {% for stime in val.stimes %}
    <a href="/trip/?id={{ stime.trip.trip_id }}&td={{ td }}" class="list-group-item list-group-item-action">
        <div class="row">
            {% if stime.provider == 'zet' %}
            <div class="d-inline" style="width: 50px">
                {{ stime.trip.route.route_short_name }}
            </div>
            {% endif %}
            <div class="col">
                {% if stime.provider == 'zet' %}
                <strong>{{ stime.trip.trip_headsign }}</strong>
                {% elif stime.provider == 'hzpp' %}
                <strong>{{ stime.trip.route.route_long_name }}</strong>
                {% endif %}
            </div>
            <div class="col-auto d-flex align-items-center gap-1">
                {% if stime.trip.bikes_allowed %}
                <i class="icon-bike"></i>
                {% endif %}
                {% if stime.trip.wheelchair_accessible %}
                <i class="icon-wheelchair"></i>
                {% endif %}

                {% if stime.departure_time_an|arrived:2 %}
                <span class="badge bg-light text-dark" style="font-size: 15px;">Stigao</span>
                {% elif stime.updated_at|within_last:4 %}
                <span class="badge bg-success" style="font-size: 15px;">{{ stime.departure_time_an|min_convert }} <i
                        class="bi bi-broadcast-pin"></i></span>
                {% elif stime.updated_at|within_last:8 %}
                <span class="badge bg-warning" style="font-size: 15px;">{{ stime.departure_time_an|min_convert }} <i
                        class="bi bi-broadcast-pin"></i></span>
                {% elif stime.updated_at|within_last:15 %}
                <span class="badge bg-danger" style="font-size: 15px;">{{ stime.departure_time_an|min_convert }} <i
                        class="bi bi-broadcast-pin"></i></span>
                {% elif stime.updated_at|within_last:30 %}
                <span class="badge bg-secondary" style="font-size: 15px;">{{ stime.departure_time_an|min_convert }}</span>
                {% else %}
                <span class="badge bg-light text-dark" style="font-size: 15px;">{{ stime.departure_time_an|min_convert }}</span>
                {% endif %}
            </div>
        </div>
        {% if user.is_superuser %}
        <div class="row font-monospace bg-dark text-white">
            <div class="col-auto">
                Departure time:<br>
                Stop sequence:<br>
                Trip id:<br>
                Delay:<br>
                Updated at:
            </div>
            <div class="col">
                {{ stime.departure_time }}<br>
                {{ stime.stop_sequence }}<br>
                {{ stime.trip.trip_id }}<br>
                {{ stime.delay_departure }}<br>
                {{ stime.updated_at|timesince }}
            </div>
        </div>
        {% endif %}
    </a>
    {% empty %}
    <div class="list-group-item">Nema polazaka.</div>
    {% endfor %}
    {% if val.stimes|length < 25 and 'td' not in request.GET %}
    <a href="?id={{ key }}&td=1&ad=1" class="list-group-item list-group-item-action text-center" style="font-size: 11px">Sljedeći dan <i class="bi bi-calendar-plus"></i></a>
    {% endif %}
</div>
{% endfor %}

<div>
    <p><span class="badge bg-success">3 min <i class="bi bi-broadcast-pin"></i></span> - Uživo praćenje vozila</p>
    <p><span class="badge bg-warning">3 min <i class="bi bi-broadcast-pin"></i></span> - Vozilo odaslalo lokaciju do
        prije 8 minuta</p>
    <p><span class="badge bg-danger">3 min <i class="bi bi-broadcast-pin"></i></span> - Vozilo odaslalo lokaciju do
        prije 15 minuta</p>
    <p><span class="badge bg-light text-dark">3 min</span> - Planirano vrijeme</p>
</div>

</div>

<script>
    function change_day(td){
        var url = `?id={{ request.GET.id }}&td=${ td }&ad=1`;
        $('#content').load(url +  ' #content');
    }
</script>
{% endblock %}